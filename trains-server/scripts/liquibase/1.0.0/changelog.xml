<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd
                      http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

  <!--    <changeSet id="1" author="paul">-->
  <!--      <sql>-->
  <!--        create extension if not exists "uuid-ossp";-->
  <!--        create extension if not exists "pgcrypto";-->
  <!--        create extension if not exists "autoinc";-->
  <!--        create extension if not exists "cube";-->
  <!--        create extension if not exists "earthdistance";-->
  <!--        alter user trains with nosuperuser;-->
  <!--      </sql>-->
  <!--      &lt;!&ndash; impossible to rollback this one, but if it got this far with the rollback, just
  rerun create.sql &ndash;&gt;-->
  <!--    </changeSet>-->

  <changeSet id="99" author="paul">
    <tagDatabase tag="initial" />
  </changeSet>

  <changeSet id="100" author="paul">
    <createTable tableName="users">
      <column name="id" type="${uuid_type}" defaultValueComputed="${uuid_function}">
        <constraints primaryKey="true" nullable="false" />
      </column>
      <column name="version" type="integer" defaultValue="0" />
      <column name="created" type="datetime" defaultValueComputed="now()">
        <constraints nullable="false" />
      </column>
      <column name="updated" type="datetime" defaultValueComputed="now()">
        <constraints nullable="false" />
      </column>
      <column name="deleted" type="datetime" />
      <column name="username" type="varchar(50)">
        <constraints nullable="false" />
      </column>
      <column name="password" type="varchar(512)">
        <constraints nullable="false" />
      </column>
      <column name="email" type="varchar(512)">
        <constraints nullable="false" />
      </column>
      <column name="scope" type="varchar(20)" defaultValue="users"> </column>
    </createTable>
  </changeSet>

  <changeSet id="110" author="paul">
    <createIndex tableName="users" indexName="users_name" unique="true">
      <column name="username" />
    </createIndex>
  </changeSet>

  <changeSet id="120" author="paul">
    <createIndex tableName="users" indexName="users_email" unique="true">
      <column name="email" />
    </createIndex>
  </changeSet>

  <changeSet id="199" author="paul">
    <loadUpdateData
            primaryKey="id"
            encoding="utf-8"
            file="../data/users.csv"
            quotchar="'"
            relativeToChangelogFile="true"
            separator=","
            tableName="users"
    >
      <column header="id" name="id" type="varchar(36)" />
      <column header="version" name="version" type="integer" />
      <column header="created" name="created" type="datetime" />
      <column header="updated" name="updated" type="datetime" />
      <column header="deleted" name="deleted" type="datetime" />
      <column header="username" name="username" type="varchar(50)" />
      <column header="password" name="password" type="varchar(512)" />
      <column header="email" name="email" type="varchar(512)" />
      <column header="scope" name="scope" type="varchar(20)" />
    </loadUpdateData>
  </changeSet>


  <changeSet id="200" author="paul">
    <createTable tableName="places">
      <column name="id" type="${uuid_type}" defaultValueComputed="${uuid_function}">
        <constraints primaryKey="true" nullable="false" />
      </column>
      <column name="version" type="integer" defaultValue="0" />
      <column name="created" type="datetime" defaultValueComputed="now()">
        <constraints nullable="false" />
      </column>
      <column name="updated" type="datetime" defaultValueComputed="now()">
        <constraints nullable="false" />
      </column>
      <column name="deleted" type="datetime" />
      <column name="name" type="varchar(100)">
        <constraints nullable="false" />
      </column>
      <column name="description" type="varchar(250)">
        <constraints nullable="false" />
      </column>
      <column name="type" type="varchar(20)">
        <constraints nullable="false" />
      </column>
      <column name="lat" type="float">
        <constraints nullable="false" />
      </column>
      <column name="lng" type="float">
        <constraints nullable="false" />
      </column>
      <column name="content" type="json" />
    </createTable>
  </changeSet>

  <changeSet id="210" author="paul">
    <createIndex tableName="places" indexName="points_name">
      <column name="name" />
    </createIndex>
  </changeSet>

  <changeSet id="299" author="paul">
    <loadUpdateData
        primaryKey="id"
        encoding="utf-8"
        file="../data/places.csv"
        quotchar="'"
        relativeToChangelogFile="true"
        separator=","
        tableName="places"
        >
      <column header="id" name="id" type="varchar(36)" />
      <column header="version" name="version" type="integer" />
      <column header="created" name="created" type="datetime" />
      <column header="updated" name="updated" type="datetime" />
      <column header="deleted" name="deleted" type="datetime" />
      <column header="name" name="name" type="varchar(100)" />
      <column header="description" name="description" type="varchar(250)" />
      <column header="type" name="type" type="varchar(20)" />
      <column header="lat" name="lat" type="float" />
      <column header="lng" name="lng" type="float" />
      <column header="content" name="content" type="json" />
    </loadUpdateData>
  </changeSet>

  <changeSet id="300" author="paul">
    <createTable tableName="posts">
      <column name="id" type="${uuid_type}" defaultValueComputed="${uuid_function}">
        <constraints primaryKey="true" nullable="false" />
      </column>
      <column name="version" type="integer" defaultValue="0" />
      <column name="created" type="datetime" defaultValueComputed="now()">
        <constraints nullable="false" />
      </column>
      <column name="updated" type="datetime" defaultValueComputed="now()">
        <constraints nullable="false" />
      </column>
      <column name="deleted" type="datetime" />
      <column name="title" type="varchar(100)">
        <constraints nullable="false" />
      </column>
      <column name="content" type="varchar(250)">
        <constraints nullable="false" />
      </column>
    </createTable>
  </changeSet>

  <changeSet id="400" author="paul">
    <createTable tableName="translations">
      <column name="id" type="${uuid_type}" defaultValueComputed="${uuid_function}">
        <constraints primaryKey="true" nullable="false" />
      </column>
      <column name="version" type="integer" defaultValue="0" />
      <column name="created" type="datetime" defaultValueComputed="now()">
        <constraints nullable="false" />
      </column>
      <column name="updated" type="datetime" defaultValueComputed="now()">
        <constraints nullable="false" />
      </column>
      <column name="deleted" type="datetime" />
      <column name="language" type="varchar(10)">
        <constraints nullable="false" />
      </column>
      <column name="key" type="varchar(250)">
        <constraints nullable="false" />
      </column>
      <column name="content" type="varchar(2000)">
        <constraints nullable="false" />
      </column>
    </createTable>
  </changeSet>

  <changeSet id="700" author="paul">
    <createTable tableName="vehicles">
      <column name="id" type="${uuid_type}" defaultValueComputed="${uuid_function}">
        <constraints primaryKey="true" nullable="false" />
      </column>
      <column name="version" type="integer" defaultValue="0" />
      <column name="created" type="datetime" defaultValueComputed="now()">
        <constraints nullable="false" />
      </column>
      <column name="updated" type="datetime" defaultValueComputed="now()">
        <constraints nullable="false" />
      </column>
      <column name="deleted" type="datetime" />

      <column name="type" type="varchar(20)">
        <constraints nullable="false" />
      </column>
      <column name="name" type="varchar(250)">
        <constraints nullable="false" />
      </column>
      <column name="description" type="varchar(250)" />

      <column name="engine_max" type="integer" defaultValue="1" />
      <column name="aux_max" type="integer" defaultValue="0" />

      <column name="engine_load" type="integer" defaultValue="1" />
      <column name="engine_fuel" type="integer" defaultValue="50" />

      <column name="aux_load" type="integer" defaultValue="1" />
      <column name="aux_fuel" type="integer" defaultValue="50" />

      <column name="speed" type="integer" defaultValue="10" />

      <column name="content" type="json"> </column>
    </createTable>
  </changeSet>

  <changeSet id="720" author="paul">
    <createIndex tableName="vehicles" indexName="vehicles_name" unique="true">
      <column name="name" />
    </createIndex>
  </changeSet>

  <changeSet id="799" author="paul">
    <loadUpdateData
            primaryKey="id"
            encoding="utf-8"
            file="../data/vehicles.csv"
            quotchar="&quot;"
            relativeToChangelogFile="true"
            separator=","
            tableName="vehicles"
    >
      <column header="id" name="id" type="varchar(36)" />
      <column header="version" name="version" type="integer" />
      <column header="created" name="created" type="datetime" />
      <column header="updated" name="updated" type="datetime" />
      <column header="deleted" name="deleted" type="datetime" />
      <column header="type" name="type" type="varchar(20)" />
      <column header="name" name="name" type="varchar(250)" />
      <column header="description" name="description" type="varchar(250)" />
      <column header="engine_max" name="engine_max" type="integer" />
      <column header="engine_load" name="engine_load" type="integer" />
      <column header="engine_fuel" name="engine_fuel" type="integer" />
      <column header="aux_max" name="aux_max" type="integer" />
      <column header="aux_load" name="aux_load" type="integer" />
      <column header="aux_fuel" name="aux_fuel" type="integer" />
      <column header="speed" name="speed" type="integer" />
      <column header="content" name="content" type="json" />
    </loadUpdateData>
  </changeSet>

  <changeSet id="800" author="paul">
    <createTable tableName="place_connections">
      <column name="id" type="${uuid_type}" defaultValueComputed="${uuid_function}">
        <constraints primaryKey="true" nullable="false" />
      </column>
      <column name="version" type="integer" defaultValue="0" />
      <column name="created" type="datetime" defaultValueComputed="now()">
        <constraints nullable="false" />
      </column>
      <column name="updated" type="datetime" defaultValueComputed="now()">
        <constraints nullable="false" />
      </column>
      <column name="deleted" type="datetime" />

      <column name="type" type="varchar(20)">
        <constraints nullable="false" />
      </column>
      <column name="name" type="varchar(250)">
        <constraints nullable="false" />
      </column>
      <column name="description" type="varchar(250)" />

      <column name="start" type="${uuid_type}">
        <constraints nullable="false" />
      </column>

      <column name="end" type="${uuid_type}">
        <constraints nullable="false" />
      </column>

      <column name="content" type="json"> </column>
    </createTable>
  </changeSet>

  <changeSet id="810" author="paul">
    <addForeignKeyConstraint
            constraintName="place_connections_start_places"
            baseTableName="place_connections"
            baseColumnNames="start"
            referencedTableName="places"
            referencedColumnNames="id" />
  </changeSet>

  <changeSet id="820" author="paul">
    <addForeignKeyConstraint
            constraintName="place_connections_end_places"
            baseTableName="place_connections"
            baseColumnNames="end"
            referencedTableName="places"
            referencedColumnNames="id" />
  </changeSet>

  <changeSet id="899" author="paul">
    <loadUpdateData
            primaryKey="id"
            encoding="utf-8"
            file="../data/place_connections.csv"
            quotchar="&quot;"
            relativeToChangelogFile="true"
            separator=","
            tableName="place_connections"
    >
      <column header="id" name="id" type="varchar(36)" />
      <column header="version" name="version" type="integer" />
      <column header="created" name="created" type="datetime" />
      <column header="updated" name="updated" type="datetime" />
      <column header="deleted" name="deleted" type="datetime" />
      <column header="type" name="type" type="varchar(20)" />
      <column header="name" name="name" type="varchar(250)" />
      <column header="description" name="description" type="varchar(250)" />
      <column header="start" name="start" type="varchar(36)" />
      <column header="end" name="end" type="varchar(36)" />
      <column header="content" name="content" type="json" />
    </loadUpdateData>
  </changeSet>

  <changeSet id="900" author="paul">
    <createTable tableName="jobs">
      <column name="id" type="${uuid_type}" defaultValueComputed="${uuid_function}">
        <constraints primaryKey="true" nullable="false" />
      </column>
      <column name="version" type="integer" defaultValue="0" />
      <column name="created" type="datetime" defaultValueComputed="now()">
        <constraints nullable="false" />
      </column>
      <column name="updated" type="datetime" defaultValueComputed="now()">
        <constraints nullable="false" />
      </column>
      <column name="deleted" type="datetime" />

      <column name="type" type="varchar(20)">
        <constraints nullable="false" />
      </column>
      <column name="name" type="varchar(250)">
        <constraints nullable="false" />
      </column>
      <column name="description" type="varchar(250)" />

      <column name="start" type="${uuid_type}">
        <constraints nullable="false" />
      </column>

      <column name="end" type="${uuid_type}">
        <constraints nullable="false" />
      </column>

      <column name="load" type="integer" defaultValue="1" />

      <column name="pay_type" type="varchar(20)" defaultValue="gold" />

      <column name="pay" type="integer" defaultValue="100" />

      <column name="start_time" type="datetime" defaultValueComputed="now()">
        <constraints nullable="false" />
      </column>

      <column name="content" type="json"> </column>
    </createTable>
  </changeSet>

  <changeSet id="910" author="paul">
    <addForeignKeyConstraint
            constraintName="jobs_start_places"
            baseTableName="jobs"
            baseColumnNames="start"
            referencedTableName="places"
            referencedColumnNames="id" />
  </changeSet>

  <changeSet id="920" author="paul">
    <addForeignKeyConstraint
            constraintName="jobs_end_places"
            baseTableName="jobs"
            baseColumnNames="end"
            referencedTableName="places"
            referencedColumnNames="id" />
  </changeSet>

  <changeSet id="930" author="paul">
    <sql>
      alter table jobs add constraint ck_jobs_type check (type in ('delivery', 'passenger', 'repair', 'rescue', 'tow'));
    </sql>
    <rollback>
      <sql>
        alter table jobs drop constraint ck_jobs_type;
      </sql>
    </rollback>
  </changeSet>

  <changeSet id="940" author="paul">
    <sql>
      alter table jobs add constraint ck_jobs_pay_type check (pay_type in ('gold', 'token', 'crate', 'material'));
    </sql>
    <rollback>
      <sql>
        alter table jobs drop constraint ck_jobs_pay_type;
      </sql>
    </rollback>
  </changeSet>

</databaseChangeLog>
